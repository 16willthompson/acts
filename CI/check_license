#!/usr/bin/env bash

# abort on error
set -ex

# check for correct number of arguments
if [ $# -ne 1 ]
then
    echo "wrong number of arguments"
    echo "usage: check_license <ACTS_DIR>"
    exit 1
fi

# check for required environment variables
: ${gitlabToken:?"'gitlabToken' not set or empty"}
: ${gitlabTargetNamespace:?"'gitlabTargetNamespace' not set or empty"}
: ${gitlabTargetRepoName:?"'gitlabTargetRepoName' not set or empty"}
: ${gitlabMergeRequestId:?"'gitlabMergeRequestId' not set or empty"}

# check for ACTS
ACTS_DIR=`readlink -f $1`
if [ ! -d "$ACTS_DIR" ]
then
    echo "ACTS_DIR='$ACTS_DIR' not found -> aborting"
    exit 1
fi

# license template
MPLv2_BEGIN="// This file is part of the ACTS project.
//
// Copyright (C) 20"
MPLv2_END=" ACTS project team
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at http://mozilla.org/MPL/2.0/."

# look for files not starting with above license template
COMMENT=""
COUNT=0
SRC_FILES=`find $ACTS_DIR -regextype egrep -regex ".*\.(hpp|cpp|ipp)"`
for f in $SRC_FILES
do
    HEAD=`head -c 64 $f`
    REST=`cat $f | dd skip=66 count=223 bs=1`
    if [ "$HEAD" != "$MPLv2_BEGIN" ] || [ "$REST" != "$MPLv2_END" ]
    then
  COUNT=$(($COUNT + 1))
  f=${f##$ACTS_DIR/}
  COMMENT="$COMMENT$f<br />";
    fi
done

# publish result as comment only if files without license statement are found
if [ $COUNT -gt 0 ]
then
    COMMENT="Found $COUNT files with missing MPLv2 license statement:<br />$COMMENT"
    ./comment_merge_request add "$COMMENT" --project $gitlabTargetNamespace/$gitlabTargetRepoName --merge-request-id $gitlabMergeRequestId --token $gitlabToken
fi

